/* State Petrol Price Script v1.1 - With City Dropdown */
(function(){"use strict";

/* CFG Check */
if(typeof CFG==="undefined"){console.error("CFG not found");return}

/* Config */
const{state:STATE,stateSlug:STATE_SLUG,fuelType:FUEL_TYPE,fuelLabel:FUEL_LABEL,capitalCity:CAPITAL_CITY}=CFG;

/* Cache */
const cache={};
const fetchJSON=url=>cache[url]||(cache[url]=fetch(url).then(r=>r.json()));

/* Utilities */
const goToURL=(sel)=>{
  const url=sel.options[sel.selectedIndex].dataset.url;
  if(url&&url!=="#")location.href=url;
};
const getPriceIndicator=change=>({
  arrow:change>0?"▲":change<0?"▼":"◼",
  color:change>0?"red":change<0?"green":"black"
});
const updateEl=(id,content,removeLoader=true)=>{
  const el=document.getElementById(id);
  if(el){
    if(typeof content==="string")el.innerHTML=content;
    else el.textContent=content;
    if(removeLoader)el.classList.remove("fuel-placeholder");
  }
};

/* Browser Back Fix */
window.addEventListener("pageshow",e=>{
  if(e.persisted||window.performance?.navigation.type===2){
    const stateEl=document.getElementById("stateSelect");
    const fuelEl=document.getElementById("fuelSelect");
    const cityEl=document.getElementById("citySelect");
    if(stateEl)stateEl.value=STATE;
    if(fuelEl)fuelEl.value=FUEL_LABEL;
    if(cityEl)cityEl.selectedIndex=0;
  }
},{passive:true});

/* Schema Injection */
const injectSchema=()=>{
  requestIdleCallback(()=>{
    document.querySelectorAll('script[type="application/ld+json"]').forEach(el=>{
      if(!el.id||el.id!=="frisqoo-custom-schema")el.remove();
    });
    
    const pageUrl=location.href;
    const org={"@type":"Organization",name:"Frisqoo",url:"https://www.frisqoo.com/"};
    
    const schema={
      "@context":"https://schema.org",
      "@graph":[
        {
          "@type":"WebPage",
          "@id":`${pageUrl}#webpage`,
          name:`${FUEL_LABEL} Prices in ${STATE} - All Cities (${currentDate})`,
          url:pageUrl,
          description:`Complete ${FUEL_LABEL.toLowerCase()} price list for all cities in ${STATE} as of ${currentDate}. Compare prices across cities and find the cheapest rates in your area.`,
          mainEntity:{"@id":`${pageUrl}#dataset`}
        },
        {
          "@type":"Dataset",
          "@id":`${pageUrl}#dataset`,
          mainEntityOfPage:{"@id":`${pageUrl}#webpage`},
          name:`${FUEL_LABEL} Prices Across All Cities in ${STATE}`,
          description:`A comprehensive dataset of ${FUEL_LABEL.toLowerCase()} prices for all cities in ${STATE}.`,
          keywords:[`${FUEL_LABEL} price in ${STATE}`,`${STATE} ${FUEL_LABEL.toLowerCase()} rates`,`fuel prices ${STATE}`,"city-wise fuel prices"],
          license:"https://creativecommons.org/licenses/by/4.0/",
          spatialCoverage:{"@type":"Place",name:STATE},
          creator:org,
          provider:org
        },
        {
          "@type":"FAQPage",
          mainEntity:Array.from(document.querySelectorAll(".showH > details")).map(faq=>({
            "@type":"Question",
            name:faq.querySelector("summary").textContent,
            acceptedAnswer:{"@type":"Answer",text:faq.querySelector(".aC p").innerHTML}
          }))
        }
      ]
    };
    
    const script=document.createElement("script");
    script.type="application/ld+json";
    script.id="frisqoo-custom-schema";
    script.text=JSON.stringify(schema);
    document.head.appendChild(script);
  },{timeout:2000});
};

/* Update FAQs */
const updateFAQs=(priceData)=>{
  if(!priceData||priceData.length<2)return;
  
  let cheapest={price:Infinity,cities:[]};
  let expensive={price:-Infinity,cities:[]};
  let capitalPrice="N/A";
  
  for(let i=1;i<priceData.length;i++){
    const[city,price]=priceData[i];
    const priceNum=parseFloat(String(price).replace(/[^0-9.-]/g,""));
    
    if(city===CAPITAL_CITY)capitalPrice=price;
    
    if(!isNaN(priceNum)){
      if(priceNum<cheapest.price)cheapest={price:priceNum,cities:[city]};
      else if(priceNum===cheapest.price)cheapest.cities.push(city);
      
      if(priceNum>expensive.price)expensive={price:priceNum,cities:[city]};
      else if(priceNum===expensive.price)expensive.cities.push(city);
    }
  }
  
  const priceDiff=expensive.price-cheapest.price;
  updateEl("faqPriceRange",
    `As of <strong>${currentDate}</strong>, petrol prices in <strong>${STATE}</strong> range from <strong>₹${cheapest.price.toFixed(2)}</strong> to <strong>₹${expensive.price.toFixed(2)}</strong> per litre, with a maximum variation of <strong>₹${priceDiff.toFixed(2)}</strong> across cities.`,
    false
  );
  
  updateEl("faqCheapest",
    `The cheapest petrol in <strong>${STATE}</strong> is currently available in <strong>${cheapest.cities.join(" and ")}</strong> at <strong>₹${cheapest.price.toFixed(2)}</strong> per litre.`,
    false
  );
  
  updateEl("faqExpensive",
    `The most expensive petrol in <strong>${STATE}</strong> is in <strong>${expensive.cities.join(" and ")}</strong> at <strong>₹${expensive.price.toFixed(2)}</strong> per litre.`,
    false
  );
  
  updateEl("faqCapitalPrice",
    `The petrol price in <strong>${CAPITAL_CITY}</strong>, the capital of ${STATE}, is <strong>${capitalPrice}</strong> per litre as of ${currentDate}.`,
    false
  );
};

/* Main Init */
const init=async()=>{
  try{
    /* Fetch all data in parallel */
    const[statesData,priceData,urlData]=await Promise.all([
      fetchJSON(`https://cdn.frisqoo.com/utilities/${FUEL_TYPE}/states.json`),
      fetchJSON(`https://cdn.frisqoo.com/${FUEL_TYPE}/${STATE_SLUG}.json`),
      fetchJSON(`https://cdn.frisqoo.com/utilities/${FUEL_TYPE}/${STATE_SLUG}.json`)
    ]);
    
    /* Populate Fuel Dropdown */
    const fuelSelect=document.getElementById("fuelSelect");
    const fuelOptions=[
      {name:"Petrol",type:"petrol"},
      {name:"Diesel",type:"diesel"},
      {name:"CNG",type:"cng"},
      {name:"LPG",type:"lpg"}
    ];
    
    if(fuelSelect){
      fuelSelect.innerHTML=fuelOptions.map(fuel=>{
        const url=`https://www.frisqoo.com/p/${fuel.type}-price-in-${STATE_SLUG}.html`;
        return`<option value="${fuel.name}" data-url="${url}"${fuel.name===FUEL_LABEL?" selected":""}>${fuel.name}</option>`;
      }).join("");
      fuelSelect.addEventListener("change",function(){goToURL(this)},{passive:true});
    }
    
    /* Populate State Dropdown */
    const stateSelect=document.getElementById("stateSelect");
    if(stateSelect){
      stateSelect.innerHTML=statesData.map(s=>
        `<option value="${s.name}" data-url="${s.url}"${s.name===STATE?" selected":""}>${s.name}</option>`
      ).join("");
      stateSelect.addEventListener("change",function(){goToURL(this)},{passive:true});
    }
    
    /* Populate City Dropdown */
    const citySelect=document.getElementById("citySelect");
    if(citySelect){
      citySelect.innerHTML=urlData.map(c=>
        `<option value="${c.name}" data-url="${c.url}"${c.name==="Select Your City"?" selected":""}>${c.name}</option>`
      ).join("");
      citySelect.addEventListener("change",function(){goToURL(this)},{passive:true});
    }
    
    /* Create URL Map */
    const urlMap={};
    urlData.forEach(item=>{
      if(item.name!=="Select Your City"){
        urlMap[item.name]=item.url;
      }
    });
    
    /* Update Table */
    const tableBody=document.querySelector("#cityPriceTable tbody");
    if(priceData?.length>1){
      const frag=document.createDocumentFragment();
      const template=document.createElement("template");
      
      template.innerHTML=priceData.slice(1).map(row=>{
        const[city,price,change]=row;
        const changeNum=parseFloat(String(change).replace(/[^0-9.-]/g,""));
        const{arrow,color}=getPriceIndicator(changeNum);
        const cityUrl=urlMap[city]||"#";
        
        return`<tr>
          <td><a href="${cityUrl}">${city}</a></td>
          <td>${price}</td>
          <td>${change} <span style="font-weight:bold;color:${color}">${arrow}</span></td>
        </tr>`;
      }).join("");
      
      frag.appendChild(template.content);
      tableBody.innerHTML="";
      tableBody.appendChild(frag);
    }else{
      tableBody.innerHTML='<tr><td colspan="3" style="text-align:center!important;padding:20px;">City price data is currently unavailable.</td></tr>';
    }
    
    /* Update FAQs */
    updateFAQs(priceData);
    
    /* Inject Schema */
    injectSchema();
    
  }catch(err){
    console.error("Init error:",err);
  }
  
  /* Low Priority Tasks */
  requestIdleCallback(()=>{
    /* Update page title */
    const titleEl=document.querySelector(".pTtl > span");
    if(titleEl){
      const titleText=titleEl.innerText.split(" - Today")[0];
      titleEl.innerHTML=`${titleText} <span style="font-size:18px">(${currentDate})</span>`;
    }
    
    /* Load related posts */
    fetchJSON("https://www.frisqoo.com/feeds/posts/summary/-/Fuel?alt=json&max-results=5")
      .then(data=>{
        const posts=(data.feed?.entry||[]).map((entry,i)=>
          `<p style="display:flex;align-items:center;margin:0"><span>${i+1}. </span><a href="${entry.link.find(l=>l.rel==="alternate").href}" target="_blank" style="margin-left:5px">${entry.title.$t}</a></p>`
        ).join("");
        
        const container=document.getElementById("related-posts");
        if(container)container.innerHTML=posts;
      })
      .catch(()=>{});
  },{timeout:3000});
};

/* Execute */
if(document.readyState==="loading"){
  document.addEventListener("DOMContentLoaded",init,{once:true,passive:true});
}else{
  init();
}

})();
