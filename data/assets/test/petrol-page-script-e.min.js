/* Fuel Price Script v1.2 - Performance Optimized */
!function(){"use strict";
if("undefined"==typeof CFG)return void console.error("CFG configuration not found");

const{state:e,city:t,stateSlug:a,citySlug:n,fuelType:r,fuelLabel:o,capitalCity:s}=CFG,
i={},
l=e=>i[e]||(i[e]=fetch(e).then(e=>e.ok?e.json():Promise.reject(e))),
c=e=>{const t=e.options[e.selectedIndex].dataset.url;t&&"#"!==t&&(location.href=t)},
d=e=>{const t=new Date(e);return `${months[t.getMonth()]} ${String(t.getDate()).padStart(2,"0")}, ${t.getFullYear()}`},
u=e=>({arrow:e>0?"▲":e<0?"▼":"▪",color:e>0?"red":e<0?"green":"black"}),
p=(e,t,a=!0)=>{const n=document.getElementById(e);n&&("string"==typeof t?n.innerHTML=t:n.textContent=t,a&&n.classList.remove("fuel-placeholder"))};

// Browser Back Fix - Only add once
let backFixAdded=false;
if(!backFixAdded){
window.addEventListener("pageshow",a=>{
if(a.persisted||2===window.performance?.navigation?.type){
const a=document.getElementById("stateSelect"),n=document.getElementById("citySelect");
a&&(a.value=e);n&&(n.value=t);
}
},{passive:!0,once:true});
backFixAdded=true;
}

// Schema Injection - Optimized with longer timeout
const m=e=>{
requestIdleCallback(()=>{
const existing=document.getElementById("frisqoo-custom-schema");
if(existing)return; // Don't recreate if exists

const a=location.href,n={"@type":"Organization",name:"Frisqoo",url:"https://www.frisqoo.com/"};
let r="";
if(e?.length>1){
const t=new Date(e[e.length-1][0]).toISOString().split("T")[0],
a=new Date().toISOString().split("T")[0];
r=`${t}/${a}`;
}
const s={
"@context":"https://schema.org",
"@graph":[
{"@type":"WebPage","@id":`${a}#webpage`,name:`${o} Price in ${t} - Today (${currentDate})`,url:a,description:`Get the latest ${o.toLowerCase()} price in ${t} for ${currentDate}. This page provides a complete daily price update, a 10-day historical price trend, a state-wide price comparison, and answers to frequently asked questions.`,mainEntity:{"@id":`${a}#dataset`}},
{"@type":"Dataset","@id":`${a}#dataset`,mainEntityOfPage:{"@id":`${a}#webpage`},name:`Daily ${o} Price History and Today's Rate for ${t}`,description:`A 10-day price history dataset for ${o.toLowerCase()} in ${t}, ${e}`,keywords:[`${o} price in ${t}`,`today ${o.toLowerCase()} rate ${t}`,`${t} ${o.toLowerCase()} price`,"fuel price","daily price update"],license:"https://creativecommons.org/licenses/by/4.0/",spatialCoverage:{"@type":"Place",name:`${t}, ${e}`},temporalCoverage:r,creator:n,provider:n},
{"@type":"FAQPage",mainEntity:Array.from(document.querySelectorAll(".showH > details")).map(e=>({
"@type":"Question",
name:e.querySelector("summary").textContent,
acceptedAnswer:{"@type":"Answer",text:e.querySelector(".aC p")?.innerHTML||""}
}))}
]
};
const i=document.createElement("script");
i.type="application/ld+json";
i.id="frisqoo-custom-schema";
i.text=JSON.stringify(s);
document.head.appendChild(i);
},{timeout:5000}); // Increased timeout
};

// FAQ Comparison - Unchanged
const f=n=>{
if(!n||n.length<2||!s){
const e=document.getElementById("faqComparisonDetails");
e&&(e.style.display="none");
return;
}
let a="N/A",i="N/A",l={price:1/0,cities:[]},c={price:-1/0,cities:[]};
for(let e=1;e<n.length;e++){
const o=n[e],[d,u]=o,p=parseFloat(String(u).replace(/[^0-9.-]/g,""));
d===t&&(a=u);
d===s&&(i=u);
if(!isNaN(p)){
if(p<l.price)l={price:p,cities:[d]};
else if(p===l.price)l.cities.push(d);
if(p>c.price)c={price:p,cities:[d]};
else if(p===c.price)c.cities.push(d);
}
}
const d=t===s?`As the state capital, this price serves as a key benchmark for other cities in ${e}.`:`For comparison, the price in the state capital <strong>${s}</strong> is <strong>${i}</strong>.`;
p("faqComparisonAnswer",`In <strong>${t}</strong>, today's ${o.toLowerCase()} price is <strong>${a}</strong>. ${d}<br><br>Currently, the cheapest ${o.toLowerCase()} in ${e} is <strong>₹${l.price.toFixed(2)}</strong> in ${l.cities.join(" and ")}, while the most expensive is <strong>₹${c.price.toFixed(2)}</strong> in ${c.cities.join(" and ")}.<br><br>For a full city-by-city breakdown, <strong><a href="https://www.frisqoo.com/p/${r}-price-in-${a}.html">view the complete ${e} ${o} price list</a></strong>.`,!1);
};

// Main Init Function - Optimized with parallel processing
const h=async()=>{
try{
// Parallel fetch all resources
const[statesData,citiesData,stateCompareData,cityHistoryData]=await Promise.all([
l(`https://cdn.frisqoo.com/utilities/${r}/states.json`),
l(`https://cdn.frisqoo.com/utilities/${r}/${a}.json`),
l(`https://cdn.frisqoo.com/${r}/${a}.json`),
l(`https://cdn.frisqoo.com/${r}/${a}/${n}.json`)
]);

// Populate Dropdowns - Use DocumentFragment for better performance
const stateSelect=document.getElementById("stateSelect");
const citySelect=document.getElementById("citySelect");
if(stateSelect&&citiesData){
const fragment=document.createDocumentFragment();
const temp=document.createElement('div');
temp.innerHTML=statesData.map(t=>`<option value="${t.name}" data-url="${t.url}"${t.name===e?" selected":""}>${t.name}</option>`).join("");
while(temp.firstChild)fragment.appendChild(temp.firstChild);
stateSelect.innerHTML="";
stateSelect.appendChild(fragment);
stateSelect.addEventListener("change",function(){c(this)},{passive:!0,once:false});
}
if(citySelect&&citiesData){
const fragment=document.createDocumentFragment();
const temp=document.createElement('div');
temp.innerHTML=citiesData.map(e=>`<option value="${e.name}" data-url="${e.url}"${e.name===t?" selected":""}>${e.name}</option>`).join("");
while(temp.firstChild)fragment.appendChild(temp.firstChild);
citySelect.innerHTML="";
citySelect.appendChild(fragment);
citySelect.addEventListener("change",function(){c(this)},{passive:!0,once:false});
}

// Update Price Info
const currentCity=stateCompareData.find((e,a)=>a>0&&e[0].trim().toLowerCase()===t.trim().toLowerCase());
if(currentCity){
const[,price,change]=currentCity;
const changeNum=parseFloat(change.replace(/[^0-9.-]/g,""));
const{arrow,color}=u(changeNum);
p("paraPrice",price);
p("petrolPriceValue",`<span style="font-size:19px;font-weight:bold">${price}</span> <span style="font-size:14px">/ltr</span><span style="font-size:14px">(₹${Math.abs(changeNum).toFixed(2)} <span style="font-weight:bold;color:${color}">${arrow}</span>)</span>`,!1);
p("petrolPriceFAQ",`The ${o.toLowerCase()} price in ${t} is <strong>${price}</strong> per litre. Prices are updated daily at 6:00 AM IST.`,!1);
const trendText=changeNum>0?`has <strong style="color:red;">increased</strong> by ₹${Math.abs(changeNum).toFixed(2)} since yesterday.`:changeNum<0?`has <strong style="color:green;">decreased</strong> by ₹${Math.abs(changeNum).toFixed(2)} since yesterday.`:`has <strong style="color:black;">remained the same</strong> compared to yesterday.`;
p("faqTrendAnswer",`Compared to yesterday, the ${o.toLowerCase()} price in <strong>${t}</strong> ${trendText}`,!1);
}

// Update Table - Use DocumentFragment
const tbody=document.querySelector("#dataTable tbody");
if(cityHistoryData?.length>1){
const fragment=document.createDocumentFragment();
const temp=document.createElement('tbody');
temp.innerHTML=cityHistoryData.slice(1).map(e=>{
const changeNum=parseFloat(String(e[2]).replace(/[^0-9.-]/g,""));
const{arrow,color}=u(changeNum);
return `<tr><td>${d(e[0])}</td><td>${e[1]}</td><td>${e[2]} <span style="font-weight:bold;color:${color}">${arrow}</span></td></tr>`;
}).join("");
while(temp.firstChild)fragment.appendChild(temp.firstChild);
tbody.innerHTML="";
tbody.appendChild(fragment);
p("faqYesterdayAnswer",`Yesterday, on <strong>${d(cityHistoryData[1][0])}</strong>, the ${o.toLowerCase()} price in <strong>${t}</strong> was <strong>${cityHistoryData[1][1]}</strong> per litre.`,!1);
}else{
tbody.innerHTML='<tr><td colspan="3" style="text-align:center!important;padding:20px;">Price history is currently unavailable.</td></tr>';
}

// Render Chart - Only if Chart.js is loaded
const initChart=()=>{
if(typeof Chart==="undefined"){
setTimeout(initChart,100);
return;
}
if(!cityHistoryData||cityHistoryData.length<2)return;

const currentCityData=stateCompareData.find((e,a)=>a>0&&e[0].trim().toLowerCase()===t.trim().toLowerCase());
let chartInstance=null,historicalData=[],selectedDays=7;
const historicalURL=`https://cdn.frisqoo.com/historical/${r}/${a}/${n}.json`;
const formatDateShort=e=>{const t=new Date(e);return `${months[t.getMonth()]} ${String(t.getDate()).padStart(2,"0")}`};
const formatDateLong=e=>{const t=new Date(e);return `${months[t.getMonth()]} ${String(t.getDate()).padStart(2,"0")}, ${t.getFullYear()}`};

const renderChart=(data,days)=>{
let filteredData=data;
if(days!=="all"&&days>0)filteredData=data.slice(-days);
if(chartInstance)chartInstance.destroy();
const isDark=document.body.classList.contains("drK");
chartInstance=new Chart(document.getElementById("priceChart"),{
type:"line",
data:{
labels:filteredData.map(e=>formatDateShort(e[0])),
datasets:[{
label:`${o} Price (₹/ltr)`,
data:filteredData.map(e=>parseFloat(String(e[1]).replace(/[^0-9.]/g,""))),
borderColor:"#4a90e2",
backgroundColor:"rgba(74,144,226,0.1)",
borderWidth:2,
pointRadius:filteredData.length>90?0:4,
pointBackgroundColor:"#4a90e2",
pointBorderColor:"#fff",
pointBorderWidth:2,
tension:0.3,
fill:true
}]
},
options:{
responsive:true,
maintainAspectRatio:false,
plugins:{
legend:{display:true,position:"top",labels:{font:{size:12},color:isDark?"#e0e0e0":"#333"}},
tooltip:{
backgroundColor:"rgba(0,0,0,0.8)",
titleColor:"#fff",
bodyColor:"#fff",
borderColor:"#4a90e2",
borderWidth:1,
padding:10,
displayColors:false,
callbacks:{
title:e=>formatDateLong(filteredData[e[0].dataIndex][0]),
label:e=>{
const idx=e.dataIndex;
const price=filteredData[idx][1];
const change=parseFloat(filteredData[idx][2]);
return [`Price: ${price}/ltr`,`Change: ${change>0?`+₹${Math.abs(change).toFixed(2)}`:change<0?`-₹${Math.abs(change).toFixed(2)}`:"No change"}`];
}
}
}
},
scales:{
x:{grid:{display:false},ticks:{font:{size:11},color:isDark?"#b0b0b0":"#666",maxRotation:45,minRotation:0,autoSkip:true,maxTicksLimit:filteredData.length>90?12:15}},
y:{beginAtZero:false,grid:{color:isDark?"rgba(255,255,255,0.1)":"rgba(0,0,0,0.05)"},ticks:{font:{size:11},color:isDark?"#b0b0b0":"#666",callback:e=>`₹${e.toFixed(2)}`}}
}
}
});
};

// Fetch historical data with fallback
let allData=[];
try{
const histData=await l(historicalURL);
allData=histData&&Array.isArray(histData)&&histData.length>1?histData.slice(1).reverse():cityHistoryData.slice(1).reverse();
}catch(err){
allData=cityHistoryData.slice(1).reverse();
}

// Add today's data if not present
if(currentCityData&&allData.length>0){
const lastDate=new Date(allData[allData.length-1][0]);
const today=new Date();
if(today.toDateString()!==lastDate.toDateString()){
const todayStr=`${months[today.getMonth()]} ${today.getDate()}, ${today.getFullYear()}`;
const todayChange=currentCityData[2]?currentCityData[2].replace(/[^0-9.-]/g,""):"0.00";
allData.push([todayStr,currentCityData[1],todayChange]);
}
}

historicalData=allData;
renderChart(historicalData,selectedDays);

// Timeframe button handlers
document.querySelectorAll(".timeframe-btn").forEach(btn=>{
btn.addEventListener("click",function(){
document.querySelectorAll(".timeframe-btn").forEach(b=>b.classList.remove("active"));
this.classList.add("active");
const days=this.dataset.days;
selectedDays=days==="all"?"all":parseInt(days);
renderChart(historicalData,selectedDays);
},{passive:true});
});

// Update ALL button text
if(historicalData.length<365){
const allBtn=document.querySelector('.timeframe-btn[data-days="all"]');
if(allBtn&&historicalData.length>0)allBtn.textContent=`${historicalData.length}D`;
}
};

// Start chart initialization
requestAnimationFrame(initChart);

// Generate FAQ & Schema
f(stateCompareData);
m(cityHistoryData);

}catch(err){
console.error("Init error:",err);
}

// Low Priority Tasks - Delayed further
requestIdleCallback(()=>{
const titleSpan=document.querySelector(".pTtl > span");
if(titleSpan){
const baseTitle=titleSpan.innerText.split(" - Today")[0];
titleSpan.innerHTML=`${baseTitle} - Today <span style="font-size:18px">(${currentDate})</span>`;
}
l("https://www.frisqoo.com/feeds/posts/summary/-/Fuel?alt=json&max-results=5")
.then(e=>{
const posts=(e.feed?.entry||[]).map((e,t)=>`<p style="display:flex;align-items:center;margin:0"><span>${t+1}. </span><a href="${e.link.find(e=>"alternate"===e.rel).href}" target="_blank" style="margin-left:5px">${e.title.$t}</a></p>`).join("");
const container=document.getElementById("related-posts");
if(container)container.innerHTML=posts;
})
.catch(()=>{});
},{timeout:5000});
};

// Execute Init
if(document.readyState==="loading"){
document.addEventListener("DOMContentLoaded",h,{passive:true,once:true});
}else{
h();
}

// Radio Button Handlers - Only add once
let radioHandlersAdded=false;
const addRadioHandlers=()=>{
if(radioHandlersAdded)return;
document.querySelectorAll('input[type=radio][name="fuelType"]').forEach(radio=>{
radio.addEventListener("change",()=>{
const link=radio.nextElementSibling?.querySelector("a");
if(link)link.click();
},{passive:true});
});
radioHandlersAdded=true;
};

if(document.readyState==="loading"){
document.addEventListener("DOMContentLoaded",addRadioHandlers,{passive:true,once:true});
}else{
addRadioHandlers();
}

}();
