/* Fuel Price Script v2.1 - Optimized for Performance */
!function(){"use strict";
/* CFG Check */
if("undefined"==typeof CFG)return void console.error("CFG not found");

/* Config */
const{state:e,city:t,stateSlug:a,citySlug:n,fuelType:r,fuelLabel:o,capitalCity:s}=CFG,i={};

/* Utilities */
const l=e=>i[e]||(i[e]=fetch(e).then(e=>e.json())),
c=e=>{const t=e.options[e.selectedIndex].dataset.url;t&&"#"!==t&&(location.href=t)},
d=e=>{const t=new Date(e);return`${months[t.getMonth()]} ${String(t.getDate()).padStart(2,"0")}, ${t.getFullYear()}`},
u=e=>({arrow:e>0?"▲":e<0?"▼":"▪",color:e>0?"red":e<0?"green":"black"}),
p=(e,t,a=!0)=>{const n=document.getElementById(e);n&&("string"==typeof t?n.innerHTML=t:n.textContent=t,a&&n.classList.remove("fuel-placeholder"))};

/* Browser Back Fix */
window.addEventListener("pageshow",a=>{if(a.persisted||2===window.performance?.navigation.type){const a=document.getElementById("stateSelect"),n=document.getElementById("citySelect");a&&(a.value=e),n&&(n.value=t)}},{passive:!0});

/* Schema Injection */
const m=e=>{requestIdleCallback(()=>{
document.querySelectorAll('script[type="application/ld+json"]').forEach(e=>{e.id&&"frisqoo-custom-schema"===e.id||e.remove()});
const a=location.href,n={"@type":"Organization",name:"Frisqoo",url:"https://www.frisqoo.com/"};
let r="";if(e?.length>1){const t=new Date(e[e.length-1][0]).toISOString().split("T")[0],a=new Date().toISOString().split("T")[0];r=`${t}/${a}`}
const s={"\u0040context":"https://schema.org","\u0040graph":[{"\u0040type":"WebPage","\u0040id":`${a}#webpage`,name:`${o} Price in ${t} - Today (${currentDate})`,url:a,description:`Get the latest ${o.toLowerCase()} price in ${t} for ${currentDate}. Daily updates, trends, and comparisons.`,mainEntity:{"\u0040id":`${a}#dataset`}},{"\u0040type":"Dataset","\u0040id":`${a}#dataset`,mainEntityOfPage:{"\u0040id":`${a}#webpage`},name:`Daily ${o} Price History for ${t}`,description:`Price dataset for ${o.toLowerCase()} in ${t}, ${e}.`,keywords:[`${o} price ${t}`,`${t} ${o.toLowerCase()} rate`,"fuel price"],license:"https://creativecommons.org/licenses/by/4.0/",spatialCoverage:{"\u0040type":"Place",name:`${t}, ${e}`},temporalCoverage:r,creator:n,provider:n},{"\u0040type":"FAQPage",mainEntity:Array.from(document.querySelectorAll(".showH > details")).map(e=>({"\u0040type":"Question",name:e.querySelector("summary").textContent,acceptedAnswer:{"\u0040type":"Answer",text:e.querySelector(".aC p").innerHTML}}))}]};
const i=document.createElement("script");i.type="application/ld+json";i.id="frisqoo-custom-schema";i.text=JSON.stringify(s);document.head.appendChild(i)
},{timeout:3e3})};

/* FAQ Comparison */
const f=n=>{if(!n||n.length<2||!s){const e=document.getElementById("faqComparisonDetails");return void(e&&(e.style.display="none"))}
let a="N/A",i="N/A",l={price:1/0,cities:[]},c={price:-1/0,cities:[]};
for(let e=1;e<n.length;e++){const o=n[e],[d,u]=o,p=parseFloat(String(u).replace(/[^0-9.-]/g,""));d===t&&(a=u),d===s&&(i=u),isNaN(p)||(p<l.price?l={price:p,cities:[d]}:p===l.price&&l.cities.push(d),p>c.price?c={price:p,cities:[d]}:p===c.price&&c.cities.push(d))}
const d=t===s?`As the state capital, this serves as a benchmark for ${e}.`:`Capital ${s} price: <strong>${i}</strong>.`;
p("faqComparisonAnswer",`In <strong>${t}</strong>, today's ${o.toLowerCase()} is <strong>${a}</strong>. ${d}<br><br>Cheapest in ${e}: <strong>₹${l.price.toFixed(2)}</strong> in ${l.cities.join(" & ")}. Most expensive: <strong>₹${c.price.toFixed(2)}</strong> in ${c.cities.join(" & ")}.<br><br><a href="https://www.frisqoo.com/p/${r}-price-in-${a}.html">View full list</a>.`,!1)
};

/* Main Init - Split into phases */
const h=async()=>{
try{
/* Phase 1: Fetch all data */
const[s,i,h,g]=await Promise.all([
l(`https://cdn.frisqoo.com/utilities/${r}/states.json`),
l(`https://cdn.frisqoo.com/utilities/${r}/${a}.json`),
l(`https://cdn.frisqoo.com/${r}/${a}.json`),
l(`https://cdn.frisqoo.com/${r}/${a}/${n}.json`)
]);

/* Phase 2: Critical UI updates (dropdowns + prices) */
requestAnimationFrame(()=>{
const n=document.getElementById("stateSelect"),r=document.getElementById("citySelect");
n.innerHTML=s.map(t=>`<option value="${t.name}" data-url="${t.url}"${t.name===e?" selected":""}>${t.name}</option>`).join("");
r.innerHTML=i.map(e=>`<option value="${e.name}" data-url="${e.url}"${e.name===t?" selected":""}>${e.name}</option>`).join("");
n.addEventListener("change",(function(){c(this)}),{passive:!0});
r.addEventListener("change",(function(){c(this)}),{passive:!0});

const a=h.find((e,a)=>a>0&&e[0].trim().toLowerCase()===t.trim().toLowerCase());
if(a){
const[,e,t]=a,n=parseFloat(t.replace(/[^0-9.-]/g,"")),{arrow:r,color:s}=u(n);
p("paraPrice",e);
p("petrolPriceValue",`<span style="font-size:19px;font-weight:bold">${e}</span> <span style="font-size:14px">/ltr</span><span style="font-size:14px">(₹${Math.abs(n).toFixed(2)} <span style="font-weight:bold;color:${s}">${r}</span>)</span>`,!1);
p("petrolPriceFAQ",`The ${o.toLowerCase()} price in ${t} is <strong>${e}</strong> per litre. Updated daily at 6 AM IST.`,!1);
const i=n>0?`has <strong style="color:red;">increased</strong> by ₹${Math.abs(n).toFixed(2)}`
:n<0?`has <strong style="color:green;">decreased</strong> by ₹${Math.abs(n).toFixed(2)}`
:`<strong>remained unchanged</strong>`;
p("faqTrendAnswer",`Today's ${o.toLowerCase()} in ${t} ${i} vs yesterday.`,!1)
}
});

/* Phase 3: Table update (deferred) */
requestIdleCallback(()=>{
const e=document.querySelector("#dataTable tbody");
if(g?.length>1){
const a=document.createDocumentFragment(),n=document.createElement("template");
n.innerHTML=g.slice(1).map(e=>{const t=parseFloat(String(e[2]).replace(/[^0-9.-]/g,"")),{arrow:a,color:n}=u(t);
return`<tr><td>${d(e[0])}</td><td>${e[1]}</td><td>${e[2]} <span style="font-weight:bold;color:${n}">${a}</span></td></tr>`}).join("");
a.appendChild(n.content);e.innerHTML="";e.appendChild(a);
p("faqYesterdayAnswer",`Yesterday (${d(g[1][0])}), ${o.toLowerCase()} in ${t} was <strong>${g[1][1]}</strong>/ltr.`,!1)
}else e.innerHTML='<tr><td colspan="3" style="text-align:center!important;padding:20px;">No data available</td></tr>'
},{timeout:100});

/* Phase 4: Chart (lazy load when visible) */
if(g?.length>1&&"undefined"!=typeof Chart){
const b=()=>{
const b=h.find((e,a)=>a>0&&e[0].trim().toLowerCase()===t.trim().toLowerCase()),
w=`https://cdn.frisqoo.com/${r}/${a}/${n}-history.json`,y=!0;
let v=null,C=[],k=7;

const S=e=>{const t=new Date(e);return`${months[t.getMonth()]} ${String(t.getDate()).padStart(2,"0")}`},
x=e=>{const t=new Date(e);return`${months[t.getMonth()]} ${String(t.getDate()).padStart(2,"0")}, ${t.getFullYear()}`};

const T=(e,t)=>{
let a=e;"all"!==t&&t>0&&(a=e.slice(-t));
v&&v.destroy();
v=new Chart(document.getElementById("priceChart"),{
type:"line",
data:{labels:a.map(e=>S(e[0])),datasets:[{label:`${o} Price (₹/ltr)`,data:a.map(e=>parseFloat(String(e[1]).replace(/[^0-9.]/g,""))),borderColor:"#4a90e2",backgroundColor:"rgba(74,144,226,0.1)",borderWidth:2,pointRadius:a.length>90?0:4,pointBackgroundColor:"#4a90e2",pointBorderColor:"#fff",pointBorderWidth:2,tension:.3,fill:!0}]},
options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!0,position:"top",labels:{font:{size:12},color:document.body.classList.contains("drK")?"#e0e0e0":"#333"}},tooltip:{backgroundColor:"rgba(0,0,0,0.8)",titleColor:"#fff",bodyColor:"#fff",borderColor:"#4a90e2",borderWidth:1,padding:10,displayColors:!1,callbacks:{title:e=>x(a[e[0].dataIndex][0]),label:e=>{const t=e.dataIndex,n=a[t][1],r=parseFloat(a[t][2]);return[`Price: ${n}/ltr`,`Change: ${r>0?`+₹${Math.abs(r).toFixed(2)}`:r<0?`-₹${Math.abs(r).toFixed(2)}`:"No change"}`]}}}},scales:{x:{grid:{display:!1},ticks:{font:{size:11},color:document.body.classList.contains("drK")?"#b0b0b0":"#666",maxRotation:45,minRotation:0,autoSkip:!0,maxTicksLimit:a.length>90?12:15}},y:{beginAtZero:!1,grid:{color:document.body.classList.contains("drK")?"rgba(255,255,255,0.1)":"rgba(0,0,0,0.05)"},ticks:{font:{size:11},color:document.body.classList.contains("drK")?"#b0b0b0":"#666",callback:e=>`₹${e.toFixed(2)}`}}}}
})
};

(async()=>{
let e=[];
if(y)try{const t=await l(w);if(t&&Array.isArray(t)&&t.length>1)e=t.slice(1).reverse(),console.log(`✓ ${e.length} days loaded`);else throw new Error("Invalid data")}catch(t){console.warn("Using 10-day:",t.message);e=g.slice(1).reverse()}else e=g.slice(1).reverse();
if(b&&e.length>0){const a=new Date(e[e.length-1][0]),n=new Date;if(n.toDateString()!==a.toDateString()){const a=`${months[n.getMonth()]} ${n.getDate()}, ${n.getFullYear()}`,r=b[2]?b[2].replace(/[^0-9.-]/g,""):"0.00";e.push([a,b[1],r])}}
C=e;T(C,k);
document.querySelectorAll(".timeframe-btn").forEach(e=>{e.addEventListener("click",(function(){document.querySelectorAll(".timeframe-btn").forEach(e=>e.classList.remove("active"));this.classList.add("active");const e=this.dataset.days;k="all"===e?"all":parseInt(e);T(C,k)}))});
C.length<365&&document.querySelector('.timeframe-btn[data-days="all"]')&&C.length>0&&(document.querySelector('.timeframe-btn[data-days="all"]').textContent=`${C.length}D`)
})()
};

/* Lazy load chart when visible */
if("IntersectionObserver"in window){
const e=new IntersectionObserver((t,a)=>{t.forEach(t=>{t.isIntersecting&&(b(),a.disconnect())})},{rootMargin:"50px"});
e.observe(document.querySelector(".chart-container"))
}else requestIdleCallback(b,{timeout:2e3})
}

/* Phase 5: FAQ & Schema (lowest priority) */
requestIdleCallback(()=>{f(h);m(g)},{timeout:500});

}catch(e){console.error("Init error:",e)}

/* Phase 6: Related posts (very low priority) */
requestIdleCallback(()=>{
const e=document.querySelector(".pTtl > span");
if(e){const t=e.innerText.split(" - Today")[0];e.innerHTML=`${t} - Today <span style="font-size:18px">(${currentDate})</span>`}
l("https://www.frisqoo.com/feeds/posts/summary/-/Fuel?alt=json&max-results=5")
.then(e=>{const t=(e.feed?.entry||[]).map((e,t)=>`<p style="display:flex;align-items:center;margin:0"><span>${t+1}. </span><a href="${e.link.find(e=>"alternate"===e.rel).href}" target="_blank" style="margin-left:5px">${e.title.$t}</a></p>`).join("");
const a=document.getElementById("related-posts");a&&(a.innerHTML=t)})
.catch(()=>{})
},{timeout:4e3})
};

/* Execute Init */
"loading"===document.readyState?document.addEventListener("DOMContentLoaded",h):h();

/* Radio Handlers */
document.addEventListener("DOMContentLoaded",()=>{
document.querySelectorAll('input[type=radio][name="fuelType"]').forEach(e=>{
e.addEventListener("change",()=>{const t=e.nextElementSibling?.querySelector("a");t&&t.click()},{passive:!0})
})
});

}();
