/* Fuel Price Script v2.0 - With Historical Chart Support */
(function() {
  "use strict";

  /* CFG Check */
  if (typeof CFG === "undefined") {
    console.error("CFG configuration not found. Please define CFG before loading this script.");
    return;
  }

  /* Config Destructuring */
  const { state, city, stateSlug, citySlug, fuelType, fuelLabel, capitalCity } = CFG;
  const cache = {};

  /* Utility: fetchJSON */
  const fetchJSON = (url) => {
    if (!cache[url]) {
      cache[url] = fetch(url).then(res => res.json());
    }
    return cache[url];
  };

  /* Utility: goToURL */
  const goToURL = (selectElement) => {
    const url = selectElement.options[selectElement.selectedIndex].dataset.url;
    if (url && url !== "#") {
      location.href = url;
    }
  };

  /* Utility: formatDate */
  const formatDate = (dateStr) => {
    const date = new Date(dateStr);
    return `${months[date.getMonth()]} ${String(date.getDate()).padStart(2, "0")}, ${date.getFullYear()}`;
  };

  /* Utility: getPriceIndicator */
  const getPriceIndicator = (change) => ({
    arrow: change > 0 ? "▲" : change < 0 ? "▼" : "▪",
    color: change > 0 ? "red" : change < 0 ? "green" : "black"
  });

  /* Utility: updateElement */
  const updateElement = (id, content, removePlaceholder = true) => {
    const element = document.getElementById(id);
    if (!element) return;
    
    if (typeof content === "string") {
      element.innerHTML = content;
    } else {
      element.textContent = content;
    }
    
    if (removePlaceholder) {
      element.classList.remove("fuel-placeholder");
    }
  };

  /* Browser Back Fix */
  window.addEventListener("pageshow", (event) => {
    if (event.persisted || window.performance?.navigation.type === 2) {
      const stateSelect = document.getElementById("stateSelect");
      const citySelect = document.getElementById("citySelect");
      if (stateSelect) stateSelect.value = state;
      if (citySelect) citySelect.value = city;
    }
  }, { passive: true });

  /* Schema Injection */
  const injectSchema = (priceData) => {
    requestIdleCallback(() => {
      // Remove old schemas
      document.querySelectorAll('script[type="application/ld+json"]').forEach(script => {
        if (!script.id || script.id !== "frisqoo-custom-schema") {
          script.remove();
        }
      });

      const pageUrl = location.href;
      const organization = {
        "@type": "Organization",
        name: "Frisqoo",
        url: "https://www.frisqoo.com/"
      };

      let temporalCoverage = "";
      if (priceData?.length > 1) {
        const startDate = new Date(priceData[priceData.length - 1][0]).toISOString().split("T")[0];
        const endDate = new Date().toISOString().split("T")[0];
        temporalCoverage = `${startDate}/${endDate}`;
      }

      const schema = {
        "@context": "https://schema.org",
        "@graph": [
          {
            "@type": "WebPage",
            "@id": `${pageUrl}#webpage`,
            name: `${fuelLabel} Price in ${city} - Today (${currentDate})`,
            url: pageUrl,
            description: `Get the latest ${fuelLabel.toLowerCase()} price in ${city} for ${currentDate}. This page provides a complete daily price update, a 10-day historical price trend, a state-wide price comparison, and answers to frequently asked questions.`,
            mainEntity: { "@id": `${pageUrl}#dataset` }
          },
          {
            "@type": "Dataset",
            "@id": `${pageUrl}#dataset`,
            mainEntityOfPage: { "@id": `${pageUrl}#webpage` },
            name: `Daily ${fuelLabel} Price History and Today's Rate for ${city}`,
            description: `A 10-day price history dataset for ${fuelLabel.toLowerCase()} in ${city}, ${state}.`,
            keywords: [
              `${fuelLabel} price in ${city}`,
              `today ${fuelLabel.toLowerCase()} rate ${city}`,
              `${city} ${fuelLabel.toLowerCase()} price`,
              "fuel price",
              "daily price update"
            ],
            license: "https://creativecommons.org/licenses/by/4.0/",
            spatialCoverage: {
              "@type": "Place",
              name: `${city}, ${state}`
            },
            temporalCoverage: temporalCoverage,
            creator: organization,
            provider: organization
          },
          {
            "@type": "FAQPage",
            mainEntity: Array.from(document.querySelectorAll(".showH > details")).map(detail => ({
              "@type": "Question",
              name: detail.querySelector("summary").textContent,
              acceptedAnswer: {
                "@type": "Answer",
                text: detail.querySelector(".aC p").innerHTML
              }
            }))
          }
        ]
      };

      const scriptTag = document.createElement("script");
      scriptTag.type = "application/ld+json";
      scriptTag.id = "frisqoo-custom-schema";
      scriptTag.text = JSON.stringify(schema);
      document.head.appendChild(scriptTag);
    }, { timeout: 2000 });
  };

  /* FAQ Comparison */
  const updateComparisonFAQ = (statePriceData) => {
    if (!statePriceData || statePriceData.length < 2 || !capitalCity) {
      const faqElement = document.getElementById("faqComparisonDetails");
      if (faqElement) faqElement.style.display = "none";
      return;
    }

    let currentCityPrice = "N/A";
    let capitalCityPrice = "N/A";
    let cheapest = { price: Infinity, cities: [] };
    let expensive = { price: -Infinity, cities: [] };

    for (let i = 1; i < statePriceData.length; i++) {
      const [cityName, priceStr] = statePriceData[i];
      const price = parseFloat(String(priceStr).replace(/[^0-9.-]/g, ""));

      if (cityName === city) currentCityPrice = priceStr;
      if (cityName === capitalCity) capitalCityPrice = priceStr;

      if (!isNaN(price)) {
        if (price < cheapest.price) {
          cheapest = { price, cities: [cityName] };
        } else if (price === cheapest.price) {
          cheapest.cities.push(cityName);
        }

        if (price > expensive.price) {
          expensive = { price, cities: [cityName] };
        } else if (price === expensive.price) {
          expensive.cities.push(cityName);
        }
      }
    }

    const capitalComparison = city === capitalCity
      ? `As the state capital, this price serves as a key benchmark for other cities in ${state}.`
      : `For comparison, the price in the state capital <strong>${capitalCity}</strong> is <strong>${capitalCityPrice}</strong>.`;

    updateElement(
      "faqComparisonAnswer",
      `In <strong>${city}</strong>, today's ${fuelLabel.toLowerCase()} price is <strong>${currentCityPrice}</strong>. ${capitalComparison}<br><br>Currently, the cheapest ${fuelLabel.toLowerCase()} in ${state} is <strong>₹${cheapest.price.toFixed(2)}</strong> in ${cheapest.cities.join(" and ")}, while the most expensive is <strong>₹${expensive.price.toFixed(2)}</strong> in ${expensive.cities.join(" and ")}.<br><br>For a full city-by-city breakdown, <strong><a href="https://www.frisqoo.com/p/${fuelType}-price-in-${stateSlug}.html">view the complete ${state} ${fuelLabel} price list</a></strong>.`,
      false
    );
  };

  /* Main Init Function */
  const init = async () => {
    try {
      const [statesData, citiesData, statePriceData, cityPriceData] = await Promise.all([
        fetchJSON(`https://cdn.frisqoo.com/utilities/${fuelType}/states.json`),
        fetchJSON(`https://cdn.frisqoo.com/utilities/${fuelType}/${stateSlug}.json`),
        fetchJSON(`https://cdn.frisqoo.com/${fuelType}/${stateSlug}.json`),
        fetchJSON(`https://cdn.frisqoo.com/${fuelType}/${stateSlug}/${citySlug}.json`)
      ]);

      /* Populate Dropdowns */
      await new Promise(resolve => {
        const stateSelect = document.getElementById("stateSelect");
        const citySelect = document.getElementById("citySelect");

        stateSelect.innerHTML = statesData.map(s =>
          `<option value="${s.name}" data-url="${s.url}"${s.name === state ? " selected" : ""}>${s.name}</option>`
        ).join("");

        citySelect.innerHTML = citiesData.map(c =>
          `<option value="${c.name}" data-url="${c.url}"${c.name === city ? " selected" : ""}>${c.name}</option>`
        ).join("");

        stateSelect.addEventListener("change", function() { goToURL(this); }, { passive: true });
        citySelect.addEventListener("change", function() { goToURL(this); }, { passive: true });

        setTimeout(resolve, 0);
      });

      /* Update Price Info */
      await new Promise(resolve => {
        const currentCityData = statePriceData.find((item, index) => 
          index > 0 && item[0].trim().toLowerCase() === city.trim().toLowerCase()
        );

        if (currentCityData) {
          const [, price, changeStr] = currentCityData;
          const change = parseFloat(changeStr.replace(/[^0-9.-]/g, ""));
          const { arrow, color } = getPriceIndicator(change);

          updateElement("paraPrice", price);
          updateElement(
            "petrolPriceValue",
            `<span style="font-size:19px;font-weight:bold">${price}</span> <span style="font-size:14px">/ltr</span><span style="font-size:14px">(₹${Math.abs(change).toFixed(2)} <span style="font-weight:bold;color:${color}">${arrow}</span>)</span>`,
            false
          );
          updateElement(
            "petrolPriceFAQ",
            `The ${fuelLabel.toLowerCase()} price in ${city} is <strong>${price}</strong> per litre. Prices are updated daily at 6:00 AM IST.`,
            false
          );

          const trendText = change > 0
            ? `has <strong style="color:red;">increased</strong> by ₹${Math.abs(change).toFixed(2)} since yesterday.`
            : change < 0
            ? `has <strong style="color:green;">decreased</strong> by ₹${Math.abs(change).toFixed(2)} since yesterday.`
            : `has <strong style="color:black;">remained the same</strong> compared to yesterday.`;

          updateElement(
            "faqTrendAnswer",
            `Compared to yesterday, the ${fuelLabel.toLowerCase()} price in <strong>${city}</strong> ${trendText}`,
            false
          );
        }

        setTimeout(resolve, 0);
      });

      /* Update Table */
      await new Promise(resolve => {
        const tbody = document.querySelector("#dataTable tbody");

        if (cityPriceData?.length > 1) {
          const fragment = document.createDocumentFragment();
          const template = document.createElement("template");

          template.innerHTML = cityPriceData.slice(1).map(row => {
            const change = parseFloat(String(row[2]).replace(/[^0-9.-]/g, ""));
            const { arrow, color } = getPriceIndicator(change);
            return `<tr><td>${formatDate(row[0])}</td><td>${row[1]}</td><td>${row[2]} <span style="font-weight:bold;color:${color}">${arrow}</span></td></tr>`;
          }).join("");

          fragment.appendChild(template.content);
          tbody.innerHTML = "";
          tbody.appendChild(fragment);

          updateElement(
            "faqYesterdayAnswer",
            `Yesterday, on <strong>${formatDate(cityPriceData[1][0])}</strong>, the ${fuelLabel.toLowerCase()} price in <strong>${city}</strong> was <strong>${cityPriceData[1][1]}</strong> per litre.`,
            false
          );
        } else {
          tbody.innerHTML = '<tr><td colspan="3" style="text-align:center!important;padding:20px;">Price history is currently unavailable.</td></tr>';
        }

        setTimeout(resolve, 0);
      });

      /* Render Price Chart with Historical Data */
      if (cityPriceData?.length > 1 && typeof Chart !== "undefined") {
        const todayPriceData = statePriceData.find((item, index) => 
          index > 0 && item[0].trim().toLowerCase() === city.trim().toLowerCase()
        );

        const HISTORICAL_DATA_URL = `https://cdn.frisqoo.com/${fuelType}/${stateSlug}/${citySlug}-history.json`;
        const USE_HISTORICAL_DATA = true;

        let chartInstance = null;
        let fullHistoricalData = [];
        let currentTimeframe = 7;

        const formatChartDate = (dateStr) => {
          const date = new Date(dateStr);
          return `${months[date.getMonth()]} ${String(date.getDate()).padStart(2, "0")}`;
        };

        const formatFullDate = (dateStr) => {
          const date = new Date(dateStr);
          return `${months[date.getMonth()]} ${String(date.getDate()).padStart(2, "0")}, ${date.getFullYear()}`;
        };

        const renderChart = (dataArray, timeframeDays) => {
          let filteredData = dataArray;
          if (timeframeDays !== "all" && timeframeDays > 0) {
            filteredData = dataArray.slice(-timeframeDays);
          }

          const chartLabels = filteredData.map(item => formatChartDate(item[0]));
          const chartPrices = filteredData.map(item => parseFloat(String(item[1]).replace(/[^0-9.]/g, "")));

          const chartConfig = {
            type: "line",
            data: {
              labels: chartLabels,
              datasets: [{
                label: `${fuelLabel} Price (₹/ltr)`,
                data: chartPrices,
                borderColor: "#4a90e2",
                backgroundColor: "rgba(74,144,226,0.1)",
                borderWidth: 2,
                pointRadius: filteredData.length > 90 ? 0 : 4,
                pointBackgroundColor: "#4a90e2",
                pointBorderColor: "#fff",
                pointBorderWidth: 2,
                tension: 0.3,
                fill: true
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  display: true,
                  position: "top",
                  labels: {
                    font: { size: 12 },
                    color: document.body.classList.contains("drK") ? "#e0e0e0" : "#333"
                  }
                },
                tooltip: {
                  backgroundColor: "rgba(0,0,0,0.8)",
                  titleColor: "#fff",
                  bodyColor: "#fff",
                  borderColor: "#4a90e2",
                  borderWidth: 1,
                  padding: 10,
                  displayColors: false,
                  callbacks: {
                    title: function(context) {
                      const index = context[0].dataIndex;
                      return formatFullDate(filteredData[index][0]);
                    },
                    label: function(context) {
                      const index = context.dataIndex;
                      const price = filteredData[index][1];
                      const change = filteredData[index][2];
                      const changeNum = parseFloat(change);
                      const changeText = changeNum > 0 
                        ? `+₹${Math.abs(changeNum).toFixed(2)}`
                        : changeNum < 0 
                        ? `-₹${Math.abs(changeNum).toFixed(2)}`
                        : "No change";
                      return [
                        `Price: ${price}/ltr`,
                        `Change: ${changeText}`
                      ];
                    }
                  }
                }
              },
              scales: {
                x: {
                  grid: { display: false },
                  ticks: {
                    font: { size: 11 },
                    color: document.body.classList.contains("drK") ? "#b0b0b0" : "#666",
                    maxRotation: 45,
                    minRotation: 0,
                    autoSkip: true,
                    maxTicksLimit: filteredData.length > 90 ? 12 : 15
                  }
                },
                y: {
                  beginAtZero: false,
                  grid: {
                    color: document.body.classList.contains("drK") ? "rgba(255,255,255,0.1)" : "rgba(0,0,0,0.05)"
                  },
                  ticks: {
                    font: { size: 11 },
                    color: document.body.classList.contains("drK") ? "#b0b0b0" : "#666",
                    callback: function(value) {
                      return `₹${value.toFixed(2)}`;
                    }
                  }
                }
              }
            }
          };

          if (chartInstance) {
            chartInstance.destroy();
          }
          chartInstance = new Chart(document.getElementById("priceChart"), chartConfig);

          // Attach event listeners to timeframe buttons
          document.querySelectorAll(".timeframe-btn").forEach(btn => {
            btn.addEventListener("click", function() {
              document.querySelectorAll(".timeframe-btn").forEach(b => b.classList.remove("active"));
              this.classList.add("active");
              const days = this.dataset.days;
              currentTimeframe = days === "all" ? "all" : parseInt(days);
              renderChart(fullHistoricalData, currentTimeframe);
            });
          });
        };

        const initChart = async () => {
          let chartData = [];

          if (USE_HISTORICAL_DATA) {
            try {
              const historicalData = await fetchJSON(HISTORICAL_DATA_URL);
              if (historicalData && Array.isArray(historicalData) && historicalData.length > 1) {
                chartData = historicalData.slice(1).reverse();
                console.log(`✓ Loaded ${chartData.length} days of historical data`);
              } else {
                throw new Error("Historical data not available or invalid format");
              }
            } catch (error) {
              console.warn("Historical data fetch failed, using 10-day data:", error.message);
              chartData = cityPriceData.slice(1).reverse();
            }
          } else {
            chartData = cityPriceData.slice(1).reverse();
          }

          // Add today's price if not already in data
          if (todayPriceData && chartData.length > 0) {
            const latestHistoricalDate = new Date(chartData[chartData.length - 1][0]);
            const today = new Date();

            if (today.toDateString() !== latestHistoricalDate.toDateString()) {
              const todayFormatted = `${months[today.getMonth()]} ${today.getDate()}, ${today.getFullYear()}`;
              const changeValue = todayPriceData[2] ? todayPriceData[2].replace(/[^0-9.-]/g, "") : "0.00";
              chartData.push([todayFormatted, todayPriceData[1], changeValue]);
            }
          }

          fullHistoricalData = chartData;
          renderChart(fullHistoricalData, currentTimeframe);

          // Update ALL button text
          if (fullHistoricalData.length < 365) {
            const allBtn = document.querySelector('.timeframe-btn[data-days="all"]');
            if (allBtn && fullHistoricalData.length > 0) {
              allBtn.textContent = `${fullHistoricalData.length}D`;
            }
          }
        };

        initChart();
      }

      /* Generate FAQ & Schema */
      updateComparisonFAQ(statePriceData);
      injectSchema(cityPriceData);

    } catch (error) {
      console.error("Init error:", error);
    }

    /* Low Priority Tasks */
    requestIdleCallback(() => {
      const titleElement = document.querySelector(".pTtl > span");
      if (titleElement) {
        const baseTitle = titleElement.innerText.split(" - Today")[0];
        titleElement.innerHTML = `${baseTitle} - Today <span style="font-size:18px">(${currentDate})</span>`;
      }

      fetchJSON("https://www.frisqoo.com/feeds/posts/summary/-/Fuel?alt=json&max-results=5")
        .then(data => {
          const posts = (data.feed?.entry || []).map((entry, index) =>
            `<p style="display:flex;align-items:center;margin:0"><span>${index + 1}. </span><a href="${entry.link.find(l => l.rel === "alternate").href}" target="_blank" style="margin-left:5px">${entry.title.$t}</a></p>`
          ).join("");
          const relatedPostsEl = document.getElementById("related-posts");
          if (relatedPostsEl) relatedPostsEl.innerHTML = posts;
        })
        .catch(() => {});
    }, { timeout: 3000 });
  };

  /* Execute Init */
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", init);
  } else {
    init();
  }

  /* Radio Button Handlers */
  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll('input[type=radio][name="fuelType"]').forEach(radio => {
      radio.addEventListener("change", () => {
        const link = radio.nextElementSibling?.querySelector("a");
        if (link) link.click();
      }, { passive: true });
    });
  });

})();
