/* State LPG Price Script v1.0 - Optimized */
(function(){"use strict";

/* CFG Check */
if(typeof CFG==="undefined"){console.error("CFG not found");return}

/* Config */
const{state:STATE,stateSlug:STATE_SLUG,fuelType:FUEL_TYPE,fuelLabel:FUEL_LABEL,capitalCity:CAPITAL_CITY}=CFG;

/* Cache */
const cache={};
const fetchJSON=url=>cache[url]||(cache[url]=fetch(url).then(r=>r.json()));

/* Utilities */
const goToURL=sel=>{const url=sel.options[sel.selectedIndex].dataset.url;if(url&&url!=="#")location.href=url};
const getPriceIndicator=change=>({arrow:change>0?"▲":change<0?"▼":"■",color:change>0?"red":change<0?"green":"black"});
const updateEl=(id,content,removeLoader=true)=>{const el=document.getElementById(id);if(el){typeof content==="string"?el.innerHTML=content:el.textContent=content;if(removeLoader)el.classList.remove("fuel-placeholder")}};

/* Parse LPG price data from format "₹906.50( 0.00 )" */
const parseLPGPrice=str=>{
  const match=str.match(/₹([\d,]+\.?\d*)\(\s*([-+]?\d+\.?\d*)\s*\)/);
  if(match){
    return{
      price:`₹${match[1]}`,
      priceNum:parseFloat(match[1].replace(/,/g,"")),
      change:parseFloat(match[2])
    }
  }
  return{price:str,priceNum:0,change:0}
};

/* Format city list */
const formatCityList=cities=>{
  if(cities.length===1)return cities[0];
  if(cities.length===2)return cities.join(" and ");
  if(cities.length===3)return cities.slice(0,2).join(", ")+", and "+cities[2];
  return`${cities.length} cities including ${cities.slice(0,2).join(", ")}, and ${cities[2]}`
};

/* Browser Back Fix */
window.addEventListener("pageshow",e=>{
  if(e.persisted||window.performance?.navigation.type===2){
    const stateEl=document.getElementById("stateSelect"),fuelEl=document.getElementById("fuelSelect"),cityEl=document.getElementById("citySelect");
    if(stateEl)stateEl.value=STATE;
    if(fuelEl)fuelEl.value=FUEL_LABEL;
    if(cityEl)cityEl.selectedIndex=0
  }
},{passive:true});

/* Schema Injection */
const injectSchema=()=>{
  requestIdleCallback(()=>{
    document.querySelectorAll('script[type="application/ld+json"]').forEach(el=>{
      if(!el.id||el.id!=="frisqoo-custom-schema")el.remove()
    });
    
    const pageUrl=location.href,org={"@type":"Organization",name:"Frisqoo",url:"https://www.frisqoo.com/"};
    
    const schema={
      "@context":"https://schema.org",
      "@graph":[
        {"@type":"WebPage","@id":`${pageUrl}#webpage`,name:`${FUEL_LABEL} Cylinder Prices in ${STATE} - All Cities (${currentDate})`,url:pageUrl,description:`Complete ${FUEL_LABEL} cylinder price list for all cities in ${STATE} as of ${currentDate}. Compare domestic and commercial cylinder prices across cities.`,mainEntity:{"@id":`${pageUrl}#dataset`}},
        {"@type":"Dataset","@id":`${pageUrl}#dataset`,mainEntityOfPage:{"@id":`${pageUrl}#webpage`},name:`${FUEL_LABEL} Cylinder Prices Across All Cities in ${STATE}`,description:`A comprehensive dataset of ${FUEL_LABEL} cylinder prices for all cities in ${STATE}, including both domestic (14.2 kg) and commercial (19 kg) cylinders.`,keywords:[`${FUEL_LABEL} price in ${STATE}`,`${STATE} ${FUEL_LABEL} rates`,`LPG cylinder prices ${STATE}`,"domestic LPG price","commercial LPG price"],license:"https://creativecommons.org/licenses/by/4.0/",spatialCoverage:{"@type":"Place",name:STATE},creator:org,provider:org},
        {"@type":"FAQPage",mainEntity:Array.from(document.querySelectorAll(".showH > details")).map(faq=>({"@type":"Question",name:faq.querySelector("summary").textContent,acceptedAnswer:{"@type":"Answer",text:faq.querySelector(".aC p").innerHTML}}))}
      ]
    };
    
    const script=document.createElement("script");
    script.type="application/ld+json";
    script.id="frisqoo-custom-schema";
    script.text=JSON.stringify(schema);
    document.head.appendChild(script)
  },{timeout:2000})
};

/* Update FAQs */
const updateFAQs=(priceData,capitalDomestic,capitalCommercial)=>{
  if(!priceData||priceData.length<2)return;
  
  let cheapestDomestic={price:Infinity,cities:[]},expensiveDomestic={price:-Infinity,cities:[]};
  let cheapestCommercial={price:Infinity,cities:[]},expensiveCommercial={price:-Infinity,cities:[]};
  
  for(let i=1;i<priceData.length;i++){
    const[city,domesticStr,commercialStr]=priceData[i];
    const domestic=parseLPGPrice(domesticStr);
    const commercial=parseLPGPrice(commercialStr);
    
    if(domestic.priceNum>0){
      if(domestic.priceNum<cheapestDomestic.price)cheapestDomestic={price:domestic.priceNum,cities:[city]};
      else if(domestic.priceNum===cheapestDomestic.price)cheapestDomestic.cities.push(city);
      
      if(domestic.priceNum>expensiveDomestic.price)expensiveDomestic={price:domestic.priceNum,cities:[city]};
      else if(domestic.priceNum===expensiveDomestic.price)expensiveDomestic.cities.push(city);
    }
    
    if(commercial.priceNum>0){
      if(commercial.priceNum<cheapestCommercial.price)cheapestCommercial={price:commercial.priceNum,cities:[city]};
      else if(commercial.priceNum===cheapestCommercial.price)cheapestCommercial.cities.push(city);
      
      if(commercial.priceNum>expensiveCommercial.price)expensiveCommercial={price:commercial.priceNum,cities:[city]};
      else if(commercial.priceNum===expensiveCommercial.price)expensiveCommercial.cities.push(city);
    }
  }
  
  const domesticDiff=expensiveDomestic.price-cheapestDomestic.price;
  
  updateEl("faqPriceRange",`As of <strong>${currentDate}</strong>, LPG cylinder prices in <strong>${STATE}</strong> vary across cities. <strong>Domestic cylinders (14.2 kg)</strong> range from <strong>₹${cheapestDomestic.price.toFixed(2)}</strong> to <strong>₹${expensiveDomestic.price.toFixed(2)}</strong>, with a variation of <strong>₹${domesticDiff.toFixed(2)}</strong>. <strong>Commercial cylinders (19 kg)</strong> range from <strong>₹${cheapestCommercial.price.toFixed(2)}</strong> to <strong>₹${expensiveCommercial.price.toFixed(2)}</strong>.`,false);
  
  updateEl("faqCheapest",`The cheapest LPG in <strong>${STATE}</strong> is currently available in <strong>${formatCityList(cheapestDomestic.cities)}</strong>. The domestic cylinder (14.2 kg) costs <strong>₹${cheapestDomestic.price.toFixed(2)}</strong> and the commercial cylinder (19 kg) costs <strong>₹${cheapestCommercial.price.toFixed(2)}</strong> in <strong>${formatCityList(cheapestCommercial.cities)}</strong>.`,false);
  
  updateEl("faqExpensive",`The most expensive LPG in <strong>${STATE}</strong> is in <strong>${formatCityList(expensiveDomestic.cities)}</strong>. The domestic cylinder (14.2 kg) costs <strong>₹${expensiveDomestic.price.toFixed(2)}</strong> and the commercial cylinder (19 kg) costs <strong>₹${expensiveCommercial.price.toFixed(2)}</strong> in <strong>${formatCityList(expensiveCommercial.cities)}</strong>.`,false);
  
  updateEl("faqCapitalPrice",`The LPG cylinder price in <strong>${CAPITAL_CITY}</strong>, the capital of ${STATE}, is <strong>${capitalDomestic}</strong> for domestic cylinders (14.2 kg) and <strong>${capitalCommercial}</strong> for commercial cylinders (19 kg) as of ${currentDate}.`,false);
};

/* Main Init */
const init=async()=>{
  try{
    const[statesData,priceData,urlData]=await Promise.all([
      fetchJSON(`https://cdn.frisqoo.com/utilities/${FUEL_TYPE}/states.json`),
      fetchJSON(`https://cdn.frisqoo.com/${FUEL_TYPE}/${STATE_SLUG}.json`),
      fetchJSON(`https://cdn.frisqoo.com/utilities/${FUEL_TYPE}/${STATE_SLUG}.json`)
    ]);
    
    /* Populate Fuel Selector */
    const fuelSelect=document.getElementById("fuelSelect");
    if(fuelSelect){
      const fuelOptions=[{name:"Petrol",type:"petrol"},{name:"Diesel",type:"diesel"},{name:"CNG",type:"cng"},{name:"LPG",type:"lpg"}];
      fuelSelect.innerHTML=fuelOptions.map(fuel=>`<option value="${fuel.name}" data-url="https://www.frisqoo.com/p/${fuel.type}-price-in-${STATE_SLUG}.html"${fuel.name===FUEL_LABEL?" selected":""}>${fuel.name}</option>`).join("");
      fuelSelect.addEventListener("change",function(){goToURL(this)},{passive:true})
    }
    
    /* Populate State Selector */
    const stateSelect=document.getElementById("stateSelect");
    if(stateSelect){
      stateSelect.innerHTML=statesData.map(s=>`<option value="${s.name}" data-url="${s.url}"${s.name===STATE?" selected":""}>${s.name}</option>`).join("");
      stateSelect.addEventListener("change",function(){goToURL(this)},{passive:true})
    }
    
    /* Populate City Selector */
    const citySelect=document.getElementById("citySelect");
    if(citySelect){
      citySelect.innerHTML=urlData.map(c=>`<option value="${c.name}" data-url="${c.url}"${c.name==="Select Your City"?" selected":""}>${c.name}</option>`).join("");
      citySelect.addEventListener("change",function(){goToURL(this)},{passive:true})
    }
    
    /* Create URL Map */
    const urlMap={};
    urlData.forEach(item=>{if(item.name!=="Select Your City")urlMap[item.name]=item.url});
    
    /* FIX BUG 1: Extract capital city prices BEFORE rendering table */
    let capitalDomestic="N/A",capitalCommercial="N/A";
    
    if(priceData?.length>1){
      // Find capital city data first
      for(let i=1;i<priceData.length;i++){
        const[city,domesticStr,commercialStr]=priceData[i];
        if(city===CAPITAL_CITY){
          const domestic=parseLPGPrice(domesticStr);
          const commercial=parseLPGPrice(commercialStr);
          capitalDomestic=domestic.price;
          capitalCommercial=commercial.price;
          break;
        }
      }
      
      /* Populate Table */
      const tableBody=document.querySelector("#cityPriceTable tbody");
      requestAnimationFrame(()=>{
        const rows=priceData.slice(1).map(row=>{
          const[city,domesticStr,commercialStr]=row;
          const domestic=parseLPGPrice(domesticStr);
          const commercial=parseLPGPrice(commercialStr);
          const{arrow:dArrow,color:dColor}=getPriceIndicator(domestic.change);
          const{arrow:cArrow,color:cColor}=getPriceIndicator(commercial.change);
          const cityUrl=urlMap[city]||"#";
          
          return`<tr style="height:50px"><td><a href="${cityUrl}">${city}</a></td><td style="text-align:right">${domestic.price} <span style="font-size:13px">(${domestic.change.toFixed(2)} <span style="font-weight:bold;color:${dColor}">${dArrow}</span>)</span></td><td style="text-align:right">${commercial.price} <span style="font-size:13px">(${commercial.change.toFixed(2)} <span style="font-weight:bold;color:${cColor}">${cArrow}</span>)</span></td></tr>`
        }).join("");
        tableBody.innerHTML=rows
      })
    }else{
      const tableBody=document.querySelector("#cityPriceTable tbody");
      tableBody.innerHTML='<tr><td colspan="3" style="text-align:center!important;padding:20px">City price data is currently unavailable.</td></tr>'
    }
    
    /* Update FAQs with extracted capital prices */
    updateFAQs(priceData,capitalDomestic,capitalCommercial);
    injectSchema()
    
  }catch(err){
    console.error("Init error:",err)
  }
  
  /* Low Priority Tasks */
  requestIdleCallback(()=>{
    const titleEl=document.querySelector(".pTtl > span");
    if(titleEl){
      const titleText=titleEl.innerText.split(" - Today")[0];
      titleEl.innerHTML=`${titleText} <span style="font-size:18px">(${currentDate})</span>`
    }
    
    fetchJSON("https://www.frisqoo.com/feeds/posts/summary/-/Fuel?alt=json&max-results=5")
      .then(data=>{
        const posts=(data.feed?.entry||[]).map((entry,i)=>`<p style="display:flex;align-items:center;margin:0"><span>${i+1}. </span><a href="${entry.link.find(l=>l.rel==="alternate").href}" target="_blank" style="margin-left:5px">${entry.title.$t}</a></p>`).join("");
        const container=document.getElementById("related-posts");
        if(container)container.innerHTML=posts
      })
      .catch(()=>{})
  },{timeout:3000})
};

/* Execute */
if(document.readyState==="loading"){
  document.addEventListener("DOMContentLoaded",init,{once:true,passive:true})
}else{
  init()
}

})();
